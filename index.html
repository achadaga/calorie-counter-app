<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Calorie Counter</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js and Annotation Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>

    <style>
        /* Custom styles to complement Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Simple loading spinner animation */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        .dark .loader {
            border-color: #4a5568; /* dark:border-gray-600 */
            border-top-color: #60a5fa; /* dark:border-blue-400 */
        }
        .chat-loader {
             border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            width: 20px;
            height: 20px;
        }
        .dark .chat-loader {
            border-color: #4a5568;
            border-top-color: #60a5fa;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Ensure chart is responsive */
        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }
    </style>
    <script>
        // Apply theme on initial load to prevent flash of wrong theme
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark')
        } else {
          document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <!-- AI Chat Modal -->
    <div id="ai-chat-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center p-4 z-50 hidden">
        <div class="flex flex-col h-full max-h-[90vh] w-full max-w-2xl bg-white dark:bg-gray-800 shadow-lg rounded-2xl">
            <!-- Header -->
            <header class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gray-900 dark:text-white">AI Nutritionist</h1>
                <button id="close-chat-btn" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </header>

            <!-- Chat Messages -->
            <div id="chat-container" class="flex-1 p-6 overflow-y-auto space-y-4">
                <!-- Initial AI Message -->
                <div class="flex items-start gap-3">
                    <div class="bg-blue-500 text-white p-2 rounded-full h-8 w-8 flex items-center justify-center font-bold">A</div>
                    <div class="bg-gray-200 dark:bg-gray-700 p-4 rounded-lg rounded-tl-none max-w-xs md:max-w-md">
                        <p>Hello! I'm your AI nutrition coach. Ask me anything about your diet, meal ideas, or how to reach your goals. How can I help you today?</p>
                    </div>
                </div>
            </div>

            <!-- Message Input -->
            <footer class="p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center gap-2">
                    <input type="text" id="chat-input" placeholder="Ask a question..." class="w-full p-3 text-lg bg-gray-100 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500">
                    <button id="chat-send-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                    </button>
                </div>
            </footer>
        </div>
    </div>


    <div id="main-container" class="container mx-auto max-w-2xl p-4 sm:p-6 lg:p-8">
        
        <!-- Header with Theme Toggle -->
        <header class="text-center mb-8 relative">
            <h1 id="welcome-message" class="text-4xl font-bold text-gray-900 dark:text-white">Smart Calorie Counter</h1>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Your personal AI-powered nutrition assistant.</p>
            <div class="absolute top-0 right-0 flex items-center space-x-2">
                <button id="open-chat-btn" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none">
                    <svg id="theme-toggle-light-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="theme-toggle-dark-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
            </div>
        </header>

        <!-- Main App Body -->
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-lg space-y-8">

            <!-- AI Coach Section -->
            <div class="ai-coach-section">
                 <h2 class="text-2xl font-bold text-gray-800 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-3 mb-4">AI Coach</h2>
                 <div id="ai-response-container" class="p-4 bg-blue-50 dark:bg-gray-700 rounded-lg min-h-[100px] flex items-center justify-center">
                     <p id="ai-response" class="text-gray-700 dark:text-gray-300 italic">Click the button below for a personalized tip on healthy Indian eating!</p>
                     <div id="ai-loader" class="loader hidden"></div>
                 </div>
                 <button id="get-ai-tip-btn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition">
                     Get Advice
                 </button>
            </div>

            <!-- Search Section -->
            <div class="search-section">
                <label for="searchInput" class="block text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Add Food</label>
                <div class="relative">
                    <input type="text" id="searchInput" placeholder="e.g., '1 cup rice' or 'samosa'" class="w-full p-4 pr-12 text-lg bg-gray-100 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition placeholder-gray-500 dark:placeholder-gray-400">
                    <div id="search-loader" class="loader absolute right-4 top-1/2 -translate-y-1/2 hidden"></div>
                </div>
                <div id="searchResults" class="mt-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-md max-h-64 overflow-y-auto"></div>
            </div>
            
            <!-- Manual Add Section -->
            <div class="manual-add-section">
                <label class="block text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Add Quick Calories</label>
                <div class="flex gap-2">
                    <input type="text" id="manualNameInput" placeholder="Optional name" class="w-2/5 p-3 text-lg bg-gray-100 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="manualCaloriesInput" placeholder="Calories" class="w-2/5 p-3 text-lg bg-gray-100 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500">
                    <button id="add-manual-btn" class="w-1/5 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">Add</button>
                </div>
            </div>

            <!-- Today's Log Section -->
            <div class="log-section">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-3 mb-4">Today's Log</h2>
                <div id="log-loader" class="flex justify-center p-4">
                    <div class="loader"></div>
                </div>
                <ul id="dailyLog" class="space-y-3"></ul>
                <div id="empty-log-message" class="text-center py-8 text-gray-500 dark:text-gray-400 hidden">
                    <p>Log your first meal to get started!</p>
                </div>
                <div class="total-calories mt-6 pt-4 border-t-2 border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xl font-semibold text-gray-700 dark:text-gray-300">Total / Goal</span>
                        <div>
                            <span id="totalCalories" class="text-3xl font-bold text-blue-600 dark:text-blue-400">0</span>
                            <span class="text-xl text-gray-500 dark:text-gray-400"> / </span>
                            <span id="calorieTarget" class="text-3xl font-bold text-gray-500 dark:text-gray-400">...</span>
                        </div>
                    </div>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                        <div id="calorie-progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Weight Tracking Section -->
            <div class="weight-tracking-section">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-3 mb-4">Weight Progress</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center mb-4">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Current</p>
                        <p class="text-2xl font-bold" id="current-weight-display">-- kg</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Goal</p>
                        <p class="text-2xl font-bold text-green-600 dark:text-green-400" id="goal-weight-display">-- kg</p>
                    </div>
                    <div class="col-span-2 md:col-span-1">
                        <p class="text-sm text-gray-500 dark:text-gray-400">Est. Goal Date</p>
                        <p class="text-2xl font-bold text-indigo-600 dark:text-indigo-400" id="goal-date-display">...</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="weightInput" step="0.1" placeholder="Enter weight in kg" class="w-full p-3 text-lg bg-gray-100 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition placeholder-gray-500 dark:placeholder-gray-400">
                    <button id="log-weight-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition">Log</button>
                </div>
                <div id="weightChartContainer" class="chart-container mt-4">
                    <canvas id="weightChart"></canvas>
                </div>
                <div id="weight-chart-loader" class="flex justify-center p-4 hidden">
                    <div class="loader"></div>
                </div>
            </div>
            
            <!-- History Chart Section -->
            <div class="history-section">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white border-b border-gray-200 dark:border-gray-700 pb-3 mb-4">Calorie History</h2>
                <div class="flex justify-center space-x-2 sm:space-x-4 mb-4">
                    <button data-days="7" class="history-btn px-4 py-2 text-sm font-medium rounded-lg bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300">7 Days</button>
                    <button data-days="15" class="history-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">15 Days</button>
                    <button data-days="30" class="history-btn px-4 py-2 text-sm font-medium rounded-lg bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300">30 Days</button>
                </div>
                <div id="calorieChartContainer" class="chart-container">
                    <canvas id="calorieHistoryChart"></canvas>
                </div>
                 <div id="calorie-chart-loader" class="flex justify-center p-4 hidden">
                    <div class="loader"></div>
                </div>
            </div>
        </div>
        
        <!-- User ID Display -->
        <div class="text-center mt-4">
            <p class="text-xs text-gray-500 dark:text-gray-500">Session ID: <span id="userIdDisplay">Not signed in</span></p>
        </div>

    </div>

    <!-- Main App Logic -->
    <script type="module">
        // --- 1. API CONFIGURATION ---
        const EDAMAM_APP_ID = 'ede9fe7e';
        const EDAMAM_APP_KEY = '4c5da630d3f71542b3113c07bd146ed6';
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY'; 

        // --- 2. DECLARE ALL VARIABLES ---
        let mainContainer, searchInput, searchResults, searchLoader, dailyLog, totalCaloriesSpan,
            calorieTargetSpan, calorieProgressBar, logLoader, emptyLogMessage, userIdDisplay,
            themeToggleButton, lightIcon, darkIcon, historyBtns, calorieChartLoader,
            calorieChartContainer, aiResponseEl, getAiTipBtn, aiLoader, weightInput,
            logWeightBtn, currentWeightDisplay, goalWeightDisplay, goalDateDisplay,
            weightChartLoader, weightChartContainer, welcomeMessage, manualNameInput,
            manualCaloriesInput, addManualBtn, aiChatModal, openChatBtn, closeChatBtn,
            chatContainer, chatInput, chatSendBtn;

        const userProfile = {
            name: 'User',
            startWeight: 87.5,
            goalWeight: 76,
            calorieTarget: 1850
        };
        let dailyItems = {};
        let calorieHistoryData = {};
        let weightHistoryData = [];
        let searchTimeout;
        let calorieHistoryChart = null;
        let weightHistoryChart = null;
        let healthDataSummary = "No data available yet.";

        // --- 3. WAIT FOR DOM TO LOAD, THEN INITIALIZE APP ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign all UI elements
            mainContainer = document.getElementById('main-container');
            searchInput = document.getElementById('searchInput');
            searchResults = document.getElementById('searchResults');
            searchLoader = document.getElementById('search-loader');
            dailyLog = document.getElementById('dailyLog');
            totalCaloriesSpan = document.getElementById('totalCalories');
            calorieTargetSpan = document.getElementById('calorieTarget');
            calorieProgressBar = document.getElementById('calorie-progress-bar');
            logLoader = document.getElementById('log-loader');
            emptyLogMessage = document.getElementById('empty-log-message');
            userIdDisplay = document.getElementById('userIdDisplay');
            themeToggleButton = document.getElementById('theme-toggle');
            lightIcon = document.getElementById('theme-toggle-light-icon');
            darkIcon = document.getElementById('theme-toggle-dark-icon');
            historyBtns = document.querySelectorAll('.history-btn');
            calorieChartLoader = document.getElementById('calorie-chart-loader');
            calorieChartContainer = document.getElementById('calorieChartContainer');
            aiResponseEl = document.getElementById('ai-response');
            getAiTipBtn = document.getElementById('get-ai-tip-btn');
            aiLoader = document.getElementById('ai-loader');
            weightInput = document.getElementById('weightInput');
            logWeightBtn = document.getElementById('log-weight-btn');
            currentWeightDisplay = document.getElementById('current-weight-display');
            goalWeightDisplay = document.getElementById('goal-weight-display');
            goalDateDisplay = document.getElementById('goal-date-display');
            weightChartLoader = document.getElementById('weight-chart-loader');
            weightChartContainer = document.getElementById('weightChartContainer');
            welcomeMessage = document.getElementById('welcome-message');
            manualNameInput = document.getElementById('manualNameInput');
            manualCaloriesInput = document.getElementById('manualCaloriesInput');
            addManualBtn = document.getElementById('add-manual-btn');
            aiChatModal = document.getElementById('ai-chat-modal');
            openChatBtn = document.getElementById('open-chat-btn');
            closeChatBtn = document.getElementById('close-chat-btn');
            chatContainer = document.getElementById('chat-container');
            chatInput = document.getElementById('chat-input');
            chatSendBtn = document.getElementById('chat-send-btn');

            // Set up event listeners
            themeToggleButton.addEventListener('click', handleThemeToggle);
            historyBtns.forEach(btn => btn.addEventListener('click', () => handleHistoryButtonClick(btn)));
            logWeightBtn.addEventListener('click', handleLogWeight);
            getAiTipBtn.addEventListener('click', getAICoachTip);
            searchInput.addEventListener('input', handleSearchInput);
            dailyLog.addEventListener('click', handleLogInteraction);
            addManualBtn.addEventListener('click', handleManualAdd);
            openChatBtn.addEventListener('click', () => aiChatModal.classList.remove('hidden'));
            closeChatBtn.addEventListener('click', () => aiChatModal.classList.add('hidden'));
            chatSendBtn.addEventListener('click', handleChatSend);
            chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleChatSend(); });

            // Start the app
            initializeAppData();
        });


        // --- THEME TOGGLE LOGIC ---
        function handleThemeToggle() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
            updateThemeIcon();
            if (calorieHistoryChart) updateChartAppearance(calorieHistoryChart);
            if (weightHistoryChart) updateChartAppearance(weightHistoryChart, true);
        }
        
        function updateThemeIcon() {
            if (document.documentElement.classList.contains('dark')) {
                lightIcon.classList.remove('hidden');
                darkIcon.classList.add('hidden');
            } else {
                lightIcon.classList.add('hidden');
                darkIcon.classList.remove('hidden');
            }
        }

        // --- APP INITIALIZATION ---
        function initializeAppData() {
            mainContainer.classList.remove('hidden');
            welcomeMessage.textContent = `Welcome, ${userProfile.name}!`;
            goalWeightDisplay.textContent = `${userProfile.goalWeight} kg`;
            calorieTargetSpan.textContent = userProfile.calorieTarget;

            getTodaysLog();
            getWeightHistory();
            fetchCalorieHistory(7);
        }

        // --- LOCAL STORAGE DATA HANDLING ---
        function getTodaysDateEDT() {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('en-CA', {
                timeZone: 'America/New_York',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            return formatter.format(now);
        }

        function getTodaysLog() {
            logLoader.classList.remove('hidden');
            const today = getTodaysDateEDT();
            const savedLog = localStorage.getItem(`log_${today}`);
            dailyItems = savedLog ? JSON.parse(savedLog) : {};
            renderLog();
            logLoader.classList.add('hidden');
        }

        function getWeightHistory() {
            const savedHistory = localStorage.getItem('weightHistory');
            weightHistoryData = savedHistory ? JSON.parse(savedHistory) : [];
            renderWeightChart(weightHistoryData);
            updateCurrentWeightDisplay();
        }

        function saveData() {
            const today = getTodaysDateEDT();
            localStorage.setItem(`log_${today}`, JSON.stringify(dailyItems));
            localStorage.setItem('weightHistory', JSON.stringify(weightHistoryData));
        }

        // --- UI & DATA MANIPULATION ---
        function addFoodToDB(foodItem) {
            const foodId = foodItem.name.replace(/[^a-zA-Z0-9]/g, '');
            if (dailyItems[foodId]) {
                dailyItems[foodId].quantity++;
            } else {
                dailyItems[foodId] = { ...foodItem, quantity: 1 };
            }
            saveData();
            renderLog();
        }
        
        function updateFoodQuantityInDB(foodId, newQuantity) {
            if (dailyItems[foodId]) {
                if (newQuantity > 0) {
                    dailyItems[foodId].quantity = newQuantity;
                } else {
                    delete dailyItems[foodId];
                }
                saveData();
                renderLog();
            }
        }

        function logWeightToDB(weight) {
            const today = getTodaysDateEDT();
            const todayEntryIndex = weightHistoryData.findIndex(entry => entry.date === today);
            if (todayEntryIndex > -1) {
                weightHistoryData[todayEntryIndex].weight = parseFloat(weight);
            } else {
                weightHistoryData.push({ date: today, weight: parseFloat(weight) });
            }
            weightHistoryData.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveData();
            renderWeightChart(weightHistoryData);
            updateCurrentWeightDisplay();
            weightInput.value = '';
        }
        
        function updateCurrentWeightDisplay() {
             if (weightHistoryData.length > 0) {
                currentWeightDisplay.textContent = `${weightHistoryData[weightHistoryData.length - 1].weight} kg`;
            } else {
                currentWeightDisplay.textContent = `${userProfile.startWeight} kg`;
            }
        }
        
        // --- HISTORY & CHARTING ---
        function fetchCalorieHistory(days) {
            calorieChartLoader.classList.remove('hidden');
            calorieChartContainer.classList.add('hidden');

            const data = {};
            for (let i = 0; i < days; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateString = new Intl.DateTimeFormat('en-CA', { timeZone: 'America/New_York', year: 'numeric', month: '2-digit', day: '2-digit' }).format(d);
                const savedLog = localStorage.getItem(`log_${dateString}`);
                const items = savedLog ? JSON.parse(savedLog) : {};
                const total = Object.values(items).reduce((sum, item) => sum + (item.calories * item.quantity), 0);
                data[dateString] = total;
            }
            calorieHistoryData = data; 
            renderCalorieHistoryChart(data);
            calculateAndDisplayGoalDate();
            calorieChartLoader.classList.add('hidden');
            calorieChartContainer.classList.remove('hidden');
        }

        function calculateAndDisplayGoalDate() {
            if (!userProfile.calorieTarget || Object.keys(calorieHistoryData).length < 3) {
                goalDateDisplay.textContent = "More data needed";
                return;
            }

            const latestWeight = weightHistoryData.length > 0 ? weightHistoryData[weightHistoryData.length-1].weight : userProfile.startWeight;
            const weightToLose = latestWeight - userProfile.goalWeight;

            if (weightToLose <= 0) {
                goalDateDisplay.textContent = "Goal Reached! 🎉";
                return;
            }

            const totalDeficitNeeded = weightToLose * 7700;
            
            const historicalIntake = Object.values(calorieHistoryData).filter(cals => cals > 0);
            if (historicalIntake.length < 3) {
                goalDateDisplay.textContent = "More data needed";
                return;
            }
            const averageIntake = historicalIntake.reduce((a, b) => a + b, 0) / historicalIntake.length;
            
            const averageDailyDeficit = userProfile.calorieTarget - averageIntake;

            if (averageDailyDeficit <= 100) {
                goalDateDisplay.textContent = "Maintain deficit";
                return;
            }

            const daysToGoal = Math.round(totalDeficitNeeded / averageDailyDeficit);
            
            const goalDate = new Date();
            goalDate.setDate(goalDate.getDate() + daysToGoal);

            goalDateDisplay.textContent = goalDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function renderCalorieHistoryChart(data) {
            const sortedDates = Object.keys(data).sort((a, b) => new Date(a) - new Date(b));
            const labels = sortedDates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const values = sortedDates.map(date => data[date]);

            if (calorieHistoryChart) {
                calorieHistoryChart.data.labels = labels;
                calorieHistoryChart.data.datasets[0].data = values;
                calorieHistoryChart.update();
            } else {
                const ctx = document.getElementById('calorieHistoryChart').getContext('2d');
                calorieHistoryChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Calories', data: values, backgroundColor: 'rgba(59, 130, 246, 0.5)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 5 }] },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
                });
            }
            updateChartAppearance(calorieHistoryChart);
        }

        function renderWeightChart(data) {
            const labels = data.map(d => new Date(d.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            const values = data.map(d => d.weight);

            if (weightHistoryChart) {
                weightHistoryChart.data.labels = labels;
                weightHistoryChart.data.datasets[0].data = values;
                weightHistoryChart.update();
            } else {
                const ctx = document.getElementById('weightChart').getContext('2d');
                weightHistoryChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ label: 'Weight (kg)', data: values, borderColor: 'rgb(22, 163, 74)', backgroundColor: 'rgba(22, 163, 74, 0.1)', fill: true, tension: 0.1 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false } },
                        plugins: { legend: { display: false }, annotation: { annotations: { goalLine: { type: 'line', yMin: userProfile.goalWeight, yMax: userProfile.goalWeight, borderColor: 'rgb(239, 68, 68)', borderWidth: 2, borderDash: [6, 6], label: { content: 'Goal', enabled: true, position: 'end', backgroundColor: 'rgba(239, 68, 68, 0.8)' } } } } }
                    }
                });
            }
            updateChartAppearance(weightHistoryChart, true);
        }
        
        function updateChartAppearance(chart, isWeightChart = false) {
            if (!chart) return;
            const isDarkMode = document.documentElement.classList.contains('dark');
            const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            const ticksColor = isDarkMode ? '#d1d5db' : '#4b5563';

            chart.options.scales.x.grid.color = gridColor;
            chart.options.scales.y.grid.color = gridColor;
            chart.options.scales.x.ticks.color = ticksColor;
            chart.options.scales.y.ticks.color = ticksColor;

            if (isWeightChart) {
                const goalLineColor = isDarkMode ? 'rgba(132, 204, 22, 0.7)' : 'rgb(239, 68, 68)';
                chart.options.plugins.annotation.annotations.goalLine.borderColor = goalLineColor;
                chart.options.plugins.annotation.annotations.goalLine.label.backgroundColor = goalLineColor;
            }

            chart.update();
        }

        function handleHistoryButtonClick(btn) {
            const days = parseInt(btn.dataset.days);
            fetchCalorieHistory(days);
            historyBtns.forEach(b => b.classList.remove('bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300'));
            btn.classList.add('bg-blue-100', 'dark:bg-blue-900', 'text-blue-700', 'dark:text-blue-300');
        }

        function handleLogWeight() {
            const weight = weightInput.value;
            if (weight) logWeightToDB(weight);
        }

        // --- GEMINI AI COACH LOGIC ---
        async function getAICoachTip() {
            aiResponseEl.classList.add('hidden');
            aiLoader.classList.remove('hidden');
            getAiTipBtn.disabled = true;

            const todayTotal = Object.values(dailyItems).reduce((sum, item) => sum + (item.calories * item.quantity), 0);
            const todayItemsString = Object.values(dailyItems).map(item => `${item.name} (${item.calories} kcal x ${item.quantity})`).join(', ') || 'nothing yet';
            const calorieHistoryString = Object.entries(calorieHistoryData).map(([date, cals]) => `${new Date(date).toLocaleDateString()}: ${cals} kcal`).join('; ');
            const latestWeight = weightHistoryData.length > 0 ? weightHistoryData[weightHistoryData.length-1].weight : userProfile.startWeight;
            const weightHistoryString = weightHistoryData.map(d => `${new Date(d.date).toLocaleDateString()}: ${d.weight} kg`).join('; ') || 'No weight logged yet.';

            const prompt = `
                You are a friendly and encouraging AI nutrition coach specializing in modern, healthy Indian cuisine for a user named ${userProfile.name}.
                The user is predominantly vegetarian but also eats eggs, tofu, and shrimp for protein.
                Their starting weight was ${userProfile.startWeight} kg. Their current weight is ${latestWeight} kg. Their goal weight is ${userProfile.goalWeight} kg. Their daily calorie target is ${userProfile.calorieTarget} kcal. The app estimates they will reach their goal on ${goalDateDisplay.textContent}.
                
                Here is their data:
                - Today's calorie log: ${todayItemsString} (Total: ${todayTotal} calories).
                - Recent calorie history: ${calorieHistoryString}.
                - Recent weight history: ${weightHistoryString}.

                Based on all this data, provide a short (2-4 sentences), motivational, and practical tip that acknowledges their weight journey and the estimated goal date.
                Your advice should be non-judgmental and MUST focus on one of these topics:
                1. A low-calorie Indian meal suggestion (e.g., using cauliflower rice, millet/jowar roti).
                2. A simple, protein-rich shake idea (e.g., with yogurt/tofu and fruit).
                3. A meal idea incorporating their preferred proteins (egg bhurji, tofu tikka, shrimp curry).
                
                Address the user directly by their name and keep the tone positive and supportive of their long-term goal.
            `;

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const result = await response.json();
                aiResponseEl.textContent = result.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("Gemini API error:", error);
                aiResponseEl.textContent = "Sorry, I couldn't generate a tip right now. Please try again later.";
            } finally {
                aiResponseEl.classList.remove('hidden');
                aiLoader.classList.add('hidden');
                getAiTipBtn.disabled = false;
            }
        }
        
        // --- EDAMAM API FOOD SEARCH ---
        function handleSearchInput() {
            clearTimeout(searchTimeout);
            const query = searchInput.value.trim();
            if (query.length < 3) {
                searchResults.innerHTML = '';
                return;
            }
            searchTimeout = setTimeout(() => searchFoodAPI(query), 500);
        }

        async function searchFoodAPI(query) {
            if (EDAMAM_APP_ID.includes('YOUR_') || EDAMAM_APP_KEY.includes('YOUR_')) {
                searchResults.innerHTML = `<div class="p-4 text-center text-red-500 dark:text-red-400">Please configure Edamam API keys.</div>`;
                return;
            }
            searchLoader.classList.remove('hidden');
            const url = `https://api.edamam.com/api/food-database/v2/parser?app_id=${EDAMAM_APP_ID}&app_key=${EDAMAM_APP_KEY}&ingr=${encodeURIComponent(query)}&nutrition-type=logging`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                displaySearchResults(data.hints);
            } catch (error) {
                searchResults.innerHTML = `<div class="p-4 text-center text-gray-600 dark:text-gray-400">Could not fetch results.</div>`;
            } finally {
                searchLoader.classList.add('hidden');
            }
        }
        
        // --- UI RENDERING & EVENT LISTENERS ---
        function displaySearchResults(foods) {
            searchResults.innerHTML = '';
            if (foods.length === 0) {
                searchResults.innerHTML = `<div class="p-4 text-center text-gray-500 dark:text-gray-400">No results found.</div>`;
                return;
            }
            foods.slice(0, 10).forEach(item => {
                const food = item.food;
                const foodName = food.label;
                const calories = food.nutrients.ENERC_KCAL ? Math.round(food.nutrients.ENERC_KCAL) : 0;
                const resultDiv = document.createElement('div');
                resultDiv.className = 'p-4 hover:bg-blue-50 dark:hover:bg-gray-700 cursor-pointer flex justify-between items-center border-t border-gray-100 dark:border-gray-700';
                resultDiv.innerHTML = `<div><p class="font-semibold text-gray-800 dark:text-gray-200">${foodName}</p><p class="text-sm text-gray-500 dark:text-gray-400">${calories} calories</p></div><button class="text-blue-600 dark:text-blue-400 font-bold text-2xl">+</button>`;
                resultDiv.addEventListener('click', () => {
                    addFoodToDB({ name: foodName, calories: calories });
                    searchInput.value = '';
                    searchResults.innerHTML = '';
                });
                searchResults.appendChild(resultDiv);
            });
        }

        function renderLog() {
            dailyLog.innerHTML = '';
            let total = 0;
            const items = Object.entries(dailyItems);
            emptyLogMessage.classList.toggle('hidden', items.length > 0);
            
            items.forEach(([foodId, item]) => {
                const listItem = document.createElement('li');
                listItem.className = 'p-4 bg-gray-100 dark:bg-gray-700 rounded-xl flex justify-between items-center';
                listItem.innerHTML = `
                    <div>
                        <p class="font-medium text-gray-900 dark:text-gray-100">${item.name}</p>
                        <p class="text-sm text-blue-600 dark:text-blue-400 font-semibold">${item.calories} calories each</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button data-id="${foodId}" data-action="decrease" class="quantity-btn text-lg font-bold w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600">-</button>
                        <span class="font-bold text-lg w-8 text-center">${item.quantity}</span>
                        <button data-id="${foodId}" data-action="increase" class="quantity-btn text-lg font-bold w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600">+</button>
                        <button data-id="${foodId}" data-action="remove" class="remove-btn text-red-500 hover:text-red-700 font-bold text-xl ml-2">&times;</button>
                    </div>
                `;
                dailyLog.appendChild(listItem);
                total += item.calories * item.quantity;
            });
            totalCaloriesSpan.textContent = total;

            const target = userProfile.calorieTarget || 0;
            calorieTargetSpan.textContent = target;
            const percentage = target > 0 ? Math.min((total / target) * 100, 100) : 0;
            calorieProgressBar.style.width = `${percentage}%`;

            calorieProgressBar.classList.remove('bg-blue-600', 'bg-orange-500', 'bg-red-600');
            if (total > target) {
                calorieProgressBar.classList.add('bg-red-600');
            } else if (percentage > 85) {
                calorieProgressBar.classList.add('bg-orange-500');
            } else {
                calorieProgressBar.classList.add('bg-blue-600');
            }
            calculateAndDisplayGoalDate();
        }

        function handleLogInteraction(e) {
            const target = e.target;
            const foodId = target.dataset.id;
            const action = target.dataset.action;

            if (!foodId || !action) return;

            const item = dailyItems[foodId];
            if (!item) return;

            if (action === 'increase') {
                updateFoodQuantityInDB(foodId, item.quantity + 1);
            } else if (action === 'decrease') {
                updateFoodQuantityInDB(foodId, item.quantity - 1);
            } else if (action === 'remove') {
                updateFoodQuantityInDB(foodId, 0); // Setting quantity to 0 removes it
            }
        }

        function handleManualAdd() {
            const name = manualNameInput.value || 'Manual Entry';
            const calories = parseInt(manualCaloriesInput.value);

            if (!calories || calories <= 0) {
                alert("Please enter a valid calorie amount.");
                return;
            }

            addFoodToDB({ name, calories });
            manualNameInput.value = '';
            manualCaloriesInput.value = '';
        }
        
        async function handleChatSend() {
            const userMessage = chatInput.value.trim();
            if (!userMessage) return;

            appendMessage(userMessage, 'user');
            chatInput.value = '';
            chatSendBtn.disabled = true;

            // Show AI typing indicator
            appendMessage('<div class="loader chat-loader"></div>', 'ai');
            const aiBubble = chatContainer.querySelector('.ai-message-bubble:last-child');

            await fetchHealthDataSummary();

            const prompt = `
                You are a friendly and encouraging AI nutrition coach specializing in modern, healthy Indian cuisine.
                The user is predominantly vegetarian but also eats eggs, tofu, and shrimp for protein.
                
                Here is the user's health data summary:
                ${healthDataSummary}

                The user has asked the following question: "${userMessage}"

                Based on their data and their question, provide a helpful, concise, and supportive answer.
                Keep your response conversational and focused on their question.
            `;

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                
                const result = await response.json();
                const aiResponse = result.candidates[0].content.parts[0].text;
                aiBubble.innerHTML = `<p>${aiResponse}</p>`; // Replace loader with response
            } catch (error) {
                console.error("Gemini API error:", error);
                aiBubble.innerHTML = `<p>Sorry, I'm having trouble connecting right now. Please try again in a moment.</p>`;
            } finally {
                chatSendBtn.disabled = false;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        function appendMessage(message, sender) {
            const messageDiv = document.createElement('div');
            if (sender === 'user') {
                messageDiv.className = 'flex items-start gap-3 justify-end';
                messageDiv.innerHTML = `
                    <div class="bg-blue-600 text-white p-4 rounded-lg rounded-br-none max-w-xs md:max-w-md">
                        <p>${message}</p>
                    </div>
                    <div class="bg-gray-300 dark:bg-gray-600 text-gray-800 dark:text-gray-200 p-2 rounded-full h-8 w-8 flex items-center justify-center font-bold">U</div>
                `;
            } else { // AI
                messageDiv.className = 'flex items-start gap-3';
                messageDiv.innerHTML = `
                    <div class="bg-blue-500 text-white p-2 rounded-full h-8 w-8 flex items-center justify-center font-bold">A</div>
                    <div class="ai-message-bubble bg-gray-200 dark:bg-gray-700 p-4 rounded-lg rounded-tl-none max-w-xs md:max-w-md">
                        ${message}
                    </div>
                `;
            }
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function fetchHealthDataSummary() {
            // Fetch last 7 days of calorie logs
            let calorieHistory = "Recent calorie history:\n";
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateString = new Intl.DateTimeFormat('en-CA', { timeZone: 'America/New_York', year: 'numeric', month: '2-digit', day: '2-digit' }).format(d);
                const savedLog = localStorage.getItem(`log_${dateString}`);
                const items = savedLog ? JSON.parse(savedLog) : {};
                const total = Object.values(items).reduce((sum, item) => sum + (item.calories * item.quantity), 0);
                calorieHistory += `- ${dateString}: ${total} kcal\n`;
            }
            
            // Fetch weight history
            const savedWeightHistory = localStorage.getItem('weightHistory');
            const weights = savedWeightHistory ? JSON.parse(savedWeightHistory) : [];
            let weightHistory = "Recent weight history:\n";
            weights.forEach(w => {
                weightHistory += `- ${w.date}: ${w.weight} kg\n`;
            });
            
            const latestWeight = weights.length > 0 ? weights[weights.length - 1].weight : userProfile.startWeight;

            healthDataSummary = `
                User Profile and Goals:
                - Name: ${userProfile.name}
                - Starting Weight: ${userProfile.startWeight} kg
                - Current Weight: ${latestWeight} kg
                - Goal Weight: ${userProfile.goalWeight} kg
                - Daily Calorie Target: ${userProfile.calorieTarget} kcal
                
                ${calorieHistory}
                ${weightHistory}
            `;
        }

    </script>
</body>
</html>
